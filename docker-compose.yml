# =============================================================================
# ROS 2 Jazzy — Docker Compose Configuration for macOS
# =============================================================================
# Usage:
#   ./run.sh start    — build (if needed) and launch the container
#   ./run.sh shell    — open an interactive shell inside the running container
#   ./run.sh stop     — stop and remove the container
#   ./run.sh build    — force-rebuild the image
#
# GUI (RViz2, rqt, Gazebo) is forwarded to XQuartz on the host.
# Ensure XQuartz is running and "Allow connections from network clients"
# is enabled in XQuartz → Preferences → Security.
#
# Inside the container use:  rv (rviz2)  rq (rqt)  gz (gazebo)
# =============================================================================

services:
  ros_dev:
    build:
      context: .
      dockerfile: Dockerfile
    image: ros2-jazzy-macos:latest
    container_name: ros_jazzy_dev

    environment:
      # ------------------------------------------------------------------
      # X11 display forwarding — XQuartz listens on display :0 of the host
      # ------------------------------------------------------------------
      - DISPLAY=host.docker.internal:0
      - QT_X11_NO_MITSHM=1

      # ------------------------------------------------------------------
      # VirtualGL + Mesa llvmpipe software rendering
      # ------------------------------------------------------------------
      # VGL_DISPLAY points VirtualGL at the Xvfb display started by
      # entrypoint.sh.  OpenGL is rendered there (offscreen, software),
      # then composited to XQuartz via plain X11 — no GLX to XQuartz.
      - VGL_DISPLAY=:99
      # VirtualGL defaults to JPEG/VGL-Transport when DISPLAY looks like a
      # network address (host.docker.internal:0), which requires a vglclient
      # daemon on the Mac.  VGL_COMPRESS=proxy forces the plain X11 transport
      # (equivalent to vglrun -c proxy) — no vglclient needed.
      - VGL_COMPRESS=proxy

      # Force Mesa's llvmpipe software renderer (OpenGL 4.5 capable)
      - GALLIUM_DRIVER=llvmpipe
      - LIBGL_ALWAYS_SOFTWARE=1

      # Tell OGRE/RViz2 the software renderer satisfies the GL 3.3 requirement.
      # Without this, OGRE rejects the context even though llvmpipe supports 4.5.
      - MESA_GL_VERSION_OVERRIDE=3.3
      - MESA_GLSL_VERSION_OVERRIDE=330

      # ------------------------------------------------------------------
      # ROS 2
      # ------------------------------------------------------------------
      - ROS_DOMAIN_ID=0
      - RCUTILS_COLORIZED_OUTPUT=1

    volumes:
      # Your ROS 2 package source — persisted on the host Mac
      - ./src:/ros2_ws/src
      # X11 Unix socket for GUI forwarding via XQuartz
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      # Named volumes keep colcon build artefacts between container restarts
      - ros2_build_cache:/ros2_ws/build
      - ros2_install_cache:/ros2_ws/install
      - ros2_log_cache:/ros2_ws/log

    stdin_open: true
    tty: true
    privileged: true
    shm_size: "512mb"
    restart: "no"

volumes:
  ros2_build_cache:
  ros2_install_cache:
  ros2_log_cache: